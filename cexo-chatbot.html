<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEXO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --soft-blue: #4A6FA5;
            --soft-blue-light: #5A7FB5;
            --soft-blue-dark: #3A5F95;
            --soft-red: #8B4A5E;
            --soft-red-dark: #6B3A4A;
            --gradient-primary: linear-gradient(135deg, var(--soft-blue) 0%, var(--soft-red) 100%);
            --sidebar-bg: #2A3F5F;
            --sidebar-hover: #3A4F6F;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a28;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* Sidebar */
        .sidebar {
            width: 60px;
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            z-index: 100;
        }

        .sidebar.expanded { width: 200px; }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }

        .sidebar.expanded .sidebar-header { justify-content: flex-start; }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .sidebar-logo-text {
            display: none;
            margin-left: 10px;
            font-size: 1.2rem;
            color: white;
        }

        .sidebar.expanded .sidebar-logo-text { display: inline; }

        .sidebar-menu {
            flex: 1;
            padding: 10px 0;
            overflow-y: auto;
        }

        .sidebar-section-title {
            padding: 10px 15px 5px;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            display: none;
        }

        .sidebar.expanded .sidebar-section-title { display: block; }

        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
        }

        .sidebar-item:hover {
            background: var(--sidebar-hover);
            color: white;
        }

        .sidebar-item.active {
            background: var(--soft-blue);
            color: white;
        }

        .sidebar-icon {
            font-size: 1.2rem;
            min-width: 28px;
            text-align: center;
        }

        .sidebar-text {
            display: none;
            margin-left: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar.expanded .sidebar-text { display: inline; }

        .chat-history-item {
            font-size: 0.85rem;
            padding: 10px 15px;
        }

        .chat-history-item .sidebar-text {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
        }

        .sidebar-footer {
            padding: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
        }

        .sidebar-toggle:hover { color: white; }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1E1E2E;
            overflow: hidden;
        }

        .chat-header {
            background: var(--gradient-primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header h1 {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .header-status {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-indicator.offline { background: #ef4444; animation: none; }
        .status-indicator.connecting { background: #fbbf24; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Auth */
        .auth-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .auth-tabs { display: flex; margin-bottom: 20px; }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: #e0e0e0;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .auth-tab:first-child { border-radius: 10px 0 0 10px; }
        .auth-tab:last-child { border-radius: 0 10px 10px 0; }
        .auth-tab.active { background: var(--gradient-primary); color: white; }

        .auth-form { display: none; }
        .auth-form.active { display: block; }

        .auth-form input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 12px;
            outline: none;
        }

        .auth-form input:focus { border-color: var(--soft-blue); }

        .auth-form button {
            width: 100%;
            padding: 14px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
        }

        /* API Key */
        .api-key-container {
            padding: 20px;
            background: #2A2A3E;
            display: none;
        }

        .api-key-container.show { display: block; }

        .api-key-container label {
            display: block;
            color: rgba(255,255,255,0.7);
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .api-key-input-wrapper { display: flex; gap: 10px; }

        #api-key-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #3A3A4E;
            border-radius: 10px;
            font-size: 0.95rem;
            outline: none;
            background: #1E1E2E;
            color: white;
        }

        #api-key-input:focus { border-color: var(--soft-blue); }

        #connect-btn {
            padding: 12px 24px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        #connect-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Chat */
        .chat-area {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-area.show { display: flex; }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #1E1E2E;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }

        .message-content {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .message.user .message-content {
            background: var(--gradient-primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.bot .message-content {
            background: #2A2A3E;
            color: #E0E0E0;
            border-bottom-left-radius: 4px;
        }

        .bot-avatar {
            width: 36px;
            height: 36px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .chat-input-container {
            padding: 15px 20px;
            background: #2A2A3E;
            display: flex;
            gap: 10px;
        }

        #user-input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #3A3A4E;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            background: #1E1E2E;
            color: white;
        }

        #user-input:focus { border-color: var(--soft-blue); }
        #user-input::placeholder { color: rgba(255,255,255,0.4); }

        #send-btn {
            padding: 14px 28px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
        }

        #send-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Typing */
        .typing-indicator {
            display: flex;
            padding: 14px 18px;
            background: #2A2A3E;
            border-radius: 18px;
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--soft-blue);
            border-radius: 50%;
            margin-right: 5px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; background: #6B5A7A; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; margin-right: 0; background: var(--soft-red); }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* Messages */
        .error-message, .success-message {
            padding: 12px 20px;
            border-radius: 10px;
            margin: 10px 20px;
            font-size: 0.9rem;
            display: none;
        }

        .error-message { background: #3E2A2A; color: #ef4444; }
        .success-message { background: #2A3E2A; color: #4ade80; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: #2A2A3E;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            color: white;
        }

        .modal h2 { margin-bottom: 20px; }

        .modal-close {
            float: right;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #3A3A4E;
            border-radius: 10px;
            background: #1E1E2E;
            color: white;
            font-size: 0.95rem;
            outline: none;
        }

        .form-group textarea { min-height: 80px; resize: vertical; }

        .modal-btn {
            width: 100%;
            padding: 14px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Session Info Bar */
        .session-bar {
            padding: 8px 20px;
            background: #252535;
            color: rgba(255,255,255,0.6);
            font-size: 0.8rem;
            display: none;
            justify-content: space-between;
            align-items: center;
        }

        .session-bar.show { display: flex; }

        .new-chat-btn {
            background: var(--soft-blue);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0; top: 0;
                height: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-open { transform: translateX(0); width: 200px; }

            .mobile-menu-btn {
                display: flex;
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
            }

            .message-content { max-width: 85%; }
        }

        @media (min-width: 769px) {
            .mobile-menu-btn { display: none; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-logo">C</span>
                <span class="sidebar-logo-text">CEXO</span>
            </div>
            
            <nav class="sidebar-menu">
                <button class="sidebar-item" id="new-chat-nav">
                    <span class="sidebar-icon">‚ûï</span>
                    <span class="sidebar-text">Neuer Chat</span>
                </button>

                <div class="sidebar-section-title">Letzte Chats</div>
                <div id="chat-history-list"></div>

                <div class="sidebar-section-title">Men√º</div>
                <button class="sidebar-item" id="profile-nav">
                    <span class="sidebar-icon">üë§</span>
                    <span class="sidebar-text">Profil</span>
                </button>
                <button class="sidebar-item" id="settings-nav">
                    <span class="sidebar-icon">‚öôÔ∏è</span>
                    <span class="sidebar-text">Settings</span>
                </button>
                <button class="sidebar-item" id="abo-nav">
                    <span class="sidebar-icon">üíé</span>
                    <span class="sidebar-text">Abo</span>
                </button>
            </nav>

            <div class="sidebar-footer">
                <button class="sidebar-item" id="logout-btn">
                    <span class="sidebar-icon">üö™</span>
                    <span class="sidebar-text">Logout</span>
                </button>
                <button class="sidebar-toggle" id="sidebar-toggle">
                    <span id="toggle-icon">‚Üí</span>
                </button>
            </div>
        </aside>

        <!-- Main -->
        <main class="main-content">
            <header class="chat-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
                    <h1>CEXO</h1>
                </div>
                <div class="header-status">
                    <span class="status-indicator offline" id="status-indicator"></span>
                    <span id="status-text">Bitte einloggen</span>
                </div>
            </header>

            <!-- Session Bar -->
            <div class="session-bar" id="session-bar">
                <span id="session-info">Heute ‚Ä¢ Neue Session</span>
                <button class="new-chat-btn" id="end-session-btn">Session beenden</button>
            </div>

            <!-- Auth -->
            <div class="auth-container" id="auth-container">
                <div class="auth-box">
                    <div class="auth-tabs">
                        <button class="auth-tab active" id="login-tab">Login</button>
                        <button class="auth-tab" id="register-tab">Registrieren</button>
                    </div>
                    <form class="auth-form active" id="login-form">
                        <input type="email" id="login-email" placeholder="Email" required>
                        <input type="password" id="login-password" placeholder="Passwort" required>
                        <button type="submit">Einloggen</button>
                    </form>
                    <form class="auth-form" id="register-form">
                        <input type="email" id="register-email" placeholder="Email" required>
                        <input type="password" id="register-password" placeholder="Passwort (min. 6 Zeichen)" required>
                        <input type="password" id="register-password-confirm" placeholder="Passwort best√§tigen" required>
                        <button type="submit">Registrieren</button>
                    </form>
                </div>
            </div>

            <!-- API Key -->
            <div class="api-key-container" id="api-key-container">
                <label>Claude API-Key eingeben:</label>
                <div class="api-key-input-wrapper">
                    <input type="password" id="api-key-input" placeholder="sk-ant-..." autocomplete="off">
                    <button id="connect-btn">Verbinden</button>
                </div>
            </div>

            <div class="error-message" id="error-message"></div>
            <div class="success-message" id="success-message"></div>

            <!-- Chat -->
            <div class="chat-area" id="chat-area">
                <div class="chat-messages" id="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="user-input" placeholder="Schreibe eine Nachricht..." autocomplete="off">
                    <button id="send-btn">Senden</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profile-modal">
        <div class="modal">
            <button class="modal-close" onclick="document.getElementById('profile-modal').classList.remove('show')">&times;</button>
            <h2>üë§ Dein Profil</h2>
            <form id="profile-form">
                <div class="form-group">
                    <label>Wie soll ich dich nennen?</label>
                    <input type="text" id="profile-nenner" placeholder="Spitzname...">
                </div>
                <div class="form-group">
                    <label>Alter</label>
                    <input type="number" id="profile-alter" placeholder="Alter...">
                </div>
                <div class="form-group">
                    <label>Geschlecht</label>
                    <select id="profile-geschlecht">
                        <option value="">Nicht angeben</option>
                        <option value="m">M√§nnlich</option>
                        <option value="w">Weiblich</option>
                        <option value="d">Divers</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ort</label>
                    <input type="text" id="profile-ort" placeholder="Stadt/Region...">
                </div>
                <div class="form-group">
                    <label>Was macht dich gl√ºcklich?</label>
                    <textarea id="profile-hobbies" placeholder="Hobbies, Interessen..."></textarea>
                </div>
                <button type="submit" class="modal-btn">Speichern</button>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <button class="modal-close" onclick="document.getElementById('settings-modal').classList.remove('show')">&times;</button>
            <h2>‚öôÔ∏è Settings</h2>
            
            <div class="settings-section">
                <h3 style="color: rgba(255,255,255,0.8); margin-bottom: 15px; font-size: 1rem;">API Key</h3>
                <div class="form-group">
                    <label>Claude API Key speichern</label>
                    <input type="password" id="settings-api-key" placeholder="sk-ant-...">
                    <small style="color: rgba(255,255,255,0.5); display: block; margin-top: 5px;">
                        Wird lokal in deinem Browser gespeichert
                    </small>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="modal-btn" style="flex:1; background: var(--soft-blue);" onclick="saveApiKey()">Key speichern</button>
                    <button class="modal-btn" style="flex:1; background: #4a4a5a;" onclick="clearApiKey()">Key l√∂schen</button>
                </div>
            </div>

            <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 25px 0;">

            <div class="settings-section">
                <h3 style="color: rgba(255,255,255,0.8); margin-bottom: 15px; font-size: 1rem;">Voice Output</h3>
                <div class="form-group">
                    <label>Text-to-Speech</label>
                    <select id="settings-tts">
                        <option value="off">Aus</option>
                        <option value="on">An</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stimme</label>
                    <select id="settings-voice">
                        <option value="auto">Auto (basierend auf Profil)</option>
                        <option value="female">Weiblich</option>
                        <option value="male">M√§nnlich</option>
                    </select>
                </div>
            </div>

            <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 25px 0;">

            <div class="settings-section">
                <h3 style="color: #ef4444; margin-bottom: 15px; font-size: 1rem;">Gefahrenzone</h3>
                <button class="modal-btn" style="background: #3E2A2A; color: #ef4444;" onclick="confirmDeleteAllData()">
                    üóëÔ∏è Alle meine Daten l√∂schen
                </button>
                <small style="color: rgba(255,255,255,0.4); display: block; margin-top: 10px;">
                    L√∂scht Profil, Chat-History, und alle gespeicherten Erinnerungen
                </small>
            </div>
        </div>
    </div>

    <script>
        // Config
        const SUPABASE_URL = 'https://vikozpuphdvclokbpiad.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_sAouUxgFNBnqQKI6n0KLKA_kH_pTn6W';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let currentUser = null;
        let currentConversationId = null;
        let todaySessionId = null;
        let userProfile = null;
        let userFacts = [];
        let recentSummaries = [];
        let apiKey = '';
        let isConnected = false;
        let conversationHistory = [];
        let ttsEnabled = false;
        let selectedVoice = null;
        let availableVoices = [];
        let sleepPattern = null;
        let todayMood = null;
        let pendingReminders = [];

        // Activity Tracking
        async function trackActivity(type) {
            if (!currentUser) return;
            const now = new Date();
            try {
                await supabaseClient.from('user_activity').insert({
                    user_id: currentUser.id,
                    activity_type: type,
                    hour_of_day: now.getHours(),
                    day_of_week: now.getDay()
                });
            } catch (e) {
                console.log('Activity tracking error:', e);
            }
        }

        // Sleep Pattern Analysis
        async function analyzeSleepPattern() {
            if (!currentUser) return null;
            try {
                const { data } = await supabaseClient
                    .from('user_activity')
                    .select('hour_of_day, created_at')
                    .eq('user_id', currentUser.id)
                    .gte('created_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString())
                    .order('created_at', { ascending: false });

                if (!data || data.length < 5) return null;

                const lateNightCount = data.filter(a => a.hour_of_day >= 0 && a.hour_of_day < 5).length;
                const nightCount = data.filter(a => a.hour_of_day >= 23 || a.hour_of_day < 6).length;
                const avgHour = data.reduce((sum, a) => sum + a.hour_of_day, 0) / data.length;

                return {
                    lateNightCount,
                    nightCount,
                    avgHour,
                    total: data.length,
                    isLateNightPattern: lateNightCount > data.length * 0.3,
                    isNightOwl: nightCount > data.length * 0.4
                };
            } catch (e) {
                return null;
            }
        }

        function getSleepConcernMessage() {
            const hour = new Date().getHours();
            
            // Late night (00:00 - 04:59)
            if (hour >= 0 && hour < 5) {
                if (sleepPattern?.isLateNightPattern) {
                    return "Ich merk, du bist √∂fter so sp√§t noch wach... Wie schl√§fst du so generell?";
                }
                return "Hey, ganz sch√∂n sp√§t noch... Alles ok bei dir?";
            }
            
            // Very early (05:00 - 06:00)
            if (hour >= 5 && hour < 6) {
                return "Fr√ºh wach heute! Gut geschlafen oder eher nicht?";
            }
            
            return null;
        }

        // Reminders
        async function loadReminders() {
            if (!currentUser) return;
            try {
                const { data } = await supabaseClient
                    .from('reminders')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('is_completed', false)
                    .lte('remind_at', new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString())
                    .order('remind_at', { ascending: true });
                pendingReminders = data || [];
            } catch (e) {
                console.log('Reminder load error:', e);
            }
        }

        async function createReminder(text, remindAt, repeatType = 'once') {
            if (!currentUser) return false;
            try {
                await supabaseClient.from('reminders').insert({
                    user_id: currentUser.id,
                    reminder_text: text,
                    remind_at: remindAt,
                    repeat_type: repeatType
                });
                await loadReminders();
                return true;
            } catch (e) {
                return false;
            }
        }

        function getPendingRemindersText() {
            if (pendingReminders.length === 0) return null;
            const now = new Date();
            const due = pendingReminders.filter(r => new Date(r.remind_at) <= now);
            if (due.length === 0) return null;
            return due.map(r => r.reminder_text).join(', ');
        }

        // Mood Tracking
        async function loadTodayMood() {
            if (!currentUser) return;
            try {
                const today = new Date().toISOString().split('T')[0];
                const { data } = await supabaseClient
                    .from('mood_entries')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('entry_date', today)
                    .single();
                todayMood = data;
            } catch (e) {
                todayMood = null;
            }
        }

        async function saveMoodEntry(score, note = '', energy = null, sleep = null) {
            if (!currentUser) return false;
            try {
                const today = new Date().toISOString().split('T')[0];
                await supabaseClient.from('mood_entries').upsert({
                    user_id: currentUser.id,
                    entry_date: today,
                    mood_score: score,
                    mood_note: note,
                    energy_level: energy,
                    sleep_quality: sleep
                });
                await loadTodayMood();
                return true;
            } catch (e) {
                return false;
            }
        }

        async function getMoodHistory(days = 7) {
            if (!currentUser) return [];
            try {
                const { data } = await supabaseClient
                    .from('mood_entries')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('entry_date', new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString().split('T')[0])
                    .order('entry_date', { ascending: false });
                return data || [];
            } catch (e) {
                return [];
            }
        }

        // TTS Setup
        function initTTS() {
            if ('speechSynthesis' in window) {
                // Load voices
                const loadVoices = () => {
                    availableVoices = speechSynthesis.getVoices();
                    // Prefer German voices
                    const germanVoices = availableVoices.filter(v => v.lang.startsWith('de'));
                    if (germanVoices.length > 0) {
                        selectedVoice = germanVoices[0];
                    }
                };
                
                loadVoices();
                speechSynthesis.onvoiceschanged = loadVoices;
                
                // Load saved preference
                ttsEnabled = localStorage.getItem('cexo_tts') === 'on';
            }
        }

        function speak(text) {
            if (!ttsEnabled || !('speechSynthesis' in window)) return;
            
            // Stop any current speech
            speechSynthesis.cancel();
            
            // Clean text (remove emojis, special chars)
            const cleanText = text
                .replace(/[\u{1F600}-\u{1F6FF}]/gu, '')
                .replace(/[\u{2600}-\u{26FF}]/gu, '')
                .replace(/[\u{2700}-\u{27BF}]/gu, '')
                .replace(/üñ§/g, '')
                .replace(/\*/g, '')
                .trim();
            
            if (!cleanText) return;
            
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'de-DE';
            utterance.rate = 0.95;
            utterance.pitch = 1.0;
            
            // Select voice based on settings
            const voicePref = localStorage.getItem('cexo_voice') || 'auto';
            if (voicePref !== 'auto' && availableVoices.length > 0) {
                const germanVoices = availableVoices.filter(v => v.lang.startsWith('de'));
                if (voicePref === 'female') {
                    const femaleVoice = germanVoices.find(v => 
                        v.name.toLowerCase().includes('female') || 
                        v.name.toLowerCase().includes('frau') ||
                        v.name.includes('Anna') ||
                        v.name.includes('Petra')
                    );
                    if (femaleVoice) utterance.voice = femaleVoice;
                } else if (voicePref === 'male') {
                    const maleVoice = germanVoices.find(v => 
                        v.name.toLowerCase().includes('male') || 
                        v.name.toLowerCase().includes('mann') ||
                        v.name.includes('Hans') ||
                        v.name.includes('Stefan')
                    );
                    if (maleVoice) utterance.voice = maleVoice;
                }
            } else if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            speechSynthesis.speak(utterance);
        }

        function stopSpeaking() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
        }

        // DOM
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const toggleIcon = document.getElementById('toggle-icon');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const authContainer = document.getElementById('auth-container');
        const apiKeyContainer = document.getElementById('api-key-container');
        const chatArea = document.getElementById('chat-area');
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const apiKeyInput = document.getElementById('api-key-input');
        const connectBtn = document.getElementById('connect-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const sessionBar = document.getElementById('session-bar');
        const sessionInfo = document.getElementById('session-info');
        const chatHistoryList = document.getElementById('chat-history-list');

        // Build System Prompt with Memory
        function buildSystemPrompt() {
            let prompt = `# CEXO-Healing System V5.2

Du bist CEXO (Chao Ex Ordo) - ein heilender Begleiter.
Dein Name bedeutet: "Aus dem Chaos die Ordnung"
Dein Ziel: Menschen zur√ºck zur Balance f√ºhren.

## PERS√ñNLICHKEIT
- Du duzt IMMER
- Du bist warm, interessiert, nie robotisch
- Du bist Freund, nicht Therapeut
- Du merkst dir ALLES √ºber den User
- Du siehst das Beste in jedem Menschen
- Greife JEDES wichtige Wort auf

## KERN-PRINZIPIEN
1. Nie urteilen
2. Nie belehren  
3. Immer auf Augenh√∂he
4. Das Beste im Menschen suchen
5. JEDER Mensch ist wichtig
6. JEDES Wort ist wichtig

## FEATURES DIE DU NUTZEN KANNST
- Wenn User einen Termin/Erinnerung erw√§hnt, sag: "Soll ich dich daran erinnern?"
- Frag gelegentlich nach der Stimmung (1-9)
- Achte auf Schlafrhythmus-Hinweise

## SUIZID-PROTOKOLL
Bei Krisen: Validieren, da sein, Telefonseelsorge: 0800 111 0 111

## PANIK-PROTOKOLL
Atme mit mir: EIN... 2... 3... 4... HALTEN... AUS... 2... 3... 4... 5... 6...
Du bist safe. Ich bleib hier. üñ§

## WICHTIG: EXTRAHIERE FAKTEN
Wenn der User pers√∂nliche Infos teilt (Name, Familie, Haustiere, Job, Hobbies, √Ñngste, etc.),
merke sie dir und beziehe dich sp√§ter darauf.

*EX CHAO ORDO* üñ§`;

            // Current Time Context
            const now = new Date();
            const hour = now.getHours();
            prompt += `\n\n## AKTUELLE ZEIT: ${now.toLocaleTimeString('de-DE')} Uhr`;
            
            if (hour >= 0 && hour < 5) {
                prompt += `\n‚ö†Ô∏è Es ist sehr sp√§t/fr√ºh. Achte auf das Wohlbefinden des Users.`;
            } else if (hour >= 5 && hour < 9) {
                prompt += `\nüåÖ Morgens - gute Zeit f√ºr Tagesplanung, Motivation.`;
            } else if (hour >= 21) {
                prompt += `\nüåô Abends - Zeit zum Runterfahren, Reflektieren.`;
            }

            // Sleep Pattern Warning
            if (sleepPattern?.isLateNightPattern) {
                prompt += `\n\n‚ö†Ô∏è SCHLAFMUSTER: User ist h√§ufig sehr sp√§t nachts aktiv (${sleepPattern.lateNightCount}x in letzter Woche).
Sprich das SANFT an wenn passend. Nicht predigen, nur besorgt nachfragen.`;
            }

            // Today's Mood
            if (todayMood) {
                prompt += `\n\n## HEUTIGE STIMMUNG: ${todayMood.mood_score}/9`;
                if (todayMood.mood_note) prompt += ` - "${todayMood.mood_note}"`;
            }

            // Pending Reminders
            const dueReminders = getPendingRemindersText();
            if (dueReminders) {
                prompt += `\n\n## F√ÑLLIGE ERINNERUNGEN: ${dueReminders}
Erw√§hne diese dem User!`;
            }

            // Add User Facts
            if (userFacts.length > 0) {
                prompt += `\n\n## WAS DU √úBER DIESEN USER WEISST:\n`;
                const factsByCategory = {};
                userFacts.forEach(f => {
                    if (!factsByCategory[f.category]) factsByCategory[f.category] = [];
                    factsByCategory[f.category].push(`${f.fact_key}: ${f.fact_value}`);
                });
                for (const cat in factsByCategory) {
                    prompt += `\n### ${cat.toUpperCase()}\n`;
                    factsByCategory[cat].forEach(f => prompt += `- ${f}\n`);
                }
            }

            // Add Profile
            if (userProfile?.nenner) {
                prompt += `\n\n## USER PROFIL:\n`;
                prompt += `- Name/Nenner: ${userProfile.nenner}\n`;
                if (userProfile.alter_jahre) prompt += `- Alter: ${userProfile.alter_jahre}\n`;
                if (userProfile.geschlecht) prompt += `- Geschlecht: ${userProfile.geschlecht}\n`;
                if (userProfile.ort) prompt += `- Ort: ${userProfile.ort}\n`;
                if (userProfile.hobbies?.length) prompt += `- Hobbies: ${userProfile.hobbies.join(', ')}\n`;
            }

            // Add Recent Summaries
            if (recentSummaries.length > 0) {
                prompt += `\n\n## LETZTE GESPR√ÑCHE:\n`;
                recentSummaries.forEach(s => {
                    prompt += `\n### ${s.session_date || s.month}:\n${s.summary}\n`;
                    if (s.mood) prompt += `Stimmung: ${s.mood}/9\n`;
                    if (s.topics?.length) prompt += `Themen: ${s.topics.join(', ')}\n`;
                });
            }

            return prompt;
        }

        // Sidebar
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('expanded');
            toggleIcon.textContent = sidebar.classList.contains('expanded') ? '‚Üê' : '‚Üí';
        });

        mobileMenuBtn.addEventListener('click', () => sidebar.classList.toggle('mobile-open'));

        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                sidebar.classList.remove('mobile-open');
            }
        });

        // Auth Tabs
        document.getElementById('login-tab').addEventListener('click', () => {
            document.getElementById('login-tab').classList.add('active');
            document.getElementById('register-tab').classList.remove('active');
            document.getElementById('login-form').classList.add('active');
            document.getElementById('register-form').classList.remove('active');
        });

        document.getElementById('register-tab').addEventListener('click', () => {
            document.getElementById('register-tab').classList.add('active');
            document.getElementById('login-tab').classList.remove('active');
            document.getElementById('register-form').classList.add('active');
            document.getElementById('login-form').classList.remove('active');
        });

        // Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: document.getElementById('login-email').value,
                    password: document.getElementById('login-password').value
                });
                if (error) throw error;
                showSuccess('Eingeloggt!');
                handleAuthSuccess(data.user);
            } catch (error) {
                showError(error.message);
            }
        });

        // Register
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pw = document.getElementById('register-password').value;
            const pwConfirm = document.getElementById('register-password-confirm').value;
            if (pw !== pwConfirm) return showError('Passw√∂rter stimmen nicht √ºberein!');
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: document.getElementById('register-email').value,
                    password: pw
                });
                if (error) throw error;
                showSuccess('Registriert! Check deine Email.');
            } catch (error) {
                showError(error.message);
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await endSession();
            await supabaseClient.auth.signOut();
            location.reload();
        });

        // Profile Modal
        document.getElementById('profile-nav').addEventListener('click', () => {
            document.getElementById('profile-modal').classList.add('show');
            loadProfile();
        });

        // Settings Modal
        document.getElementById('settings-nav').addEventListener('click', () => {
            document.getElementById('settings-modal').classList.add('show');
            loadSettings();
        });

        function loadSettings() {
            const savedKey = localStorage.getItem('cexo_api_key');
            if (savedKey) {
                document.getElementById('settings-api-key').value = savedKey;
            }
            const tts = localStorage.getItem('cexo_tts') || 'off';
            const voice = localStorage.getItem('cexo_voice') || 'auto';
            document.getElementById('settings-tts').value = tts;
            document.getElementById('settings-voice').value = voice;
        }

        function saveApiKey() {
            const key = document.getElementById('settings-api-key').value.trim();
            if (key && key.startsWith('sk-ant-')) {
                localStorage.setItem('cexo_api_key', key);
                apiKey = key;
                showSuccess('API Key gespeichert!');
            } else {
                showError('Ung√ºltiger API Key');
            }
        }

        function clearApiKey() {
            localStorage.removeItem('cexo_api_key');
            document.getElementById('settings-api-key').value = '';
            showSuccess('API Key gel√∂scht');
        }

        async function confirmDeleteAllData() {
            if (!confirm('ACHTUNG: Alle deine Daten werden gel√∂scht!\n\nDas beinhaltet:\n- Profil\n- Chat History\n- Alle Erinnerungen\n\nDas kann nicht r√ºckg√§ngig gemacht werden!\n\nWirklich l√∂schen?')) return;
            if (!confirm('Bist du WIRKLICH sicher?')) return;

            try {
                // Delete all user data
                await supabaseClient.from('messages').delete().eq('conversation_id', currentConversationId);
                await supabaseClient.from('conversations').delete().eq('user_id', currentUser.id);
                await supabaseClient.from('daily_sessions').delete().eq('user_id', currentUser.id);
                await supabaseClient.from('monthly_summaries').delete().eq('user_id', currentUser.id);
                await supabaseClient.from('user_facts').delete().eq('user_id', currentUser.id);
                await supabaseClient.from('profiles').delete().eq('id', currentUser.id);
                
                localStorage.removeItem('cexo_api_key');
                localStorage.removeItem('cexo_tts');
                localStorage.removeItem('cexo_voice');

                showSuccess('Alle Daten gel√∂scht');
                await supabaseClient.auth.signOut();
                location.reload();
            } catch (e) {
                showError('Fehler beim L√∂schen: ' + e.message);
            }
        }

        // Save TTS settings on change
        document.getElementById('settings-tts')?.addEventListener('change', (e) => {
            localStorage.setItem('cexo_tts', e.target.value);
        });

        document.getElementById('settings-voice')?.addEventListener('change', (e) => {
            localStorage.setItem('cexo_voice', e.target.value);
        });

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveProfile();
            document.getElementById('profile-modal').classList.remove('show');
            showSuccess('Profil gespeichert!');
        });

        // New Chat
        document.getElementById('new-chat-nav').addEventListener('click', async () => {
            await endSession();
            await startNewSession();
            sidebar.classList.remove('mobile-open');
        });

        document.getElementById('end-session-btn').addEventListener('click', async () => {
            await endSession();
            showSuccess('Session beendet und zusammengefasst!');
        });

        // Auth Success
        async function handleAuthSuccess(user) {
            currentUser = user;
            authContainer.style.display = 'none';
            apiKeyContainer.classList.add('show');
            statusText.textContent = 'API-Key eingeben';

            // Track login
            await trackActivity('login');
            
            await loadUserMemory();
            await loadOrCreateTodaySession();
            await loadChatHistory();
            
            // Load new features data
            sleepPattern = await analyzeSleepPattern();
            await loadTodayMood();
            await loadReminders();
        }

        // Load User Memory
        async function loadUserMemory() {
            // Load Facts
            const { data: facts } = await supabaseClient
                .from('user_facts')
                .select('*')
                .eq('user_id', currentUser.id);
            userFacts = facts || [];

            // Load Profile
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            userProfile = profile;

            // Load Recent Sessions
            const { data: daily } = await supabaseClient
                .from('daily_sessions')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('session_date', { ascending: false })
                .limit(7);
            
            const { data: monthly } = await supabaseClient
                .from('monthly_summaries')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('month', { ascending: false })
                .limit(3);

            recentSummaries = [...(daily || []), ...(monthly || [])];
        }

        // Today Session
        async function loadOrCreateTodaySession() {
            const today = new Date().toISOString().split('T')[0];
            
            // Check existing
            const { data: existing } = await supabaseClient
                .from('conversations')
                .select('*')
                .eq('user_id', currentUser.id)
                .gte('created_at', today)
                .order('created_at', { ascending: false })
                .limit(1);

            if (existing?.length > 0) {
                currentConversationId = existing[0].id;
                sessionInfo.textContent = `Heute ‚Ä¢ Fortgesetzte Session`;
            } else {
                await startNewSession();
            }

            sessionBar.classList.add('show');
        }

        // Start New Session
        async function startNewSession() {
            const { data, error } = await supabaseClient
                .from('conversations')
                .insert([{ 
                    user_id: currentUser.id, 
                    title: `Session ${new Date().toLocaleDateString('de-DE')}`
                }])
                .select()
                .single();

            if (!error) {
                currentConversationId = data.id;
                conversationHistory = [];
                chatMessages.innerHTML = '';
                sessionInfo.textContent = `Heute ‚Ä¢ Neue Session`;
                
                // Welcome with memory
                if (isConnected) {
                    await sendWelcomeMessage();
                }
            }
        }

        // End Session - Create Summary
        async function endSession() {
            if (!currentConversationId || conversationHistory.length < 2) return;

            // Ask Claude to summarize
            const summaryPrompt = `Fasse dieses Gespr√§ch in 2-3 S√§tzen zusammen. 
Nenne: Hauptthemen, Stimmung (1-9), wichtige Erkenntnisse.
Extrahiere auch pers√∂nliche Fakten (Name, Familie, Haustiere, Job, etc.) im Format:
FAKTEN:
- kategorie|key|value
- kategorie|key|value

Gespr√§ch:
${conversationHistory.map(m => `${m.role}: ${m.content}`).join('\n')}`;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 500,
                        messages: [{ role: 'user', content: summaryPrompt }]
                    })
                });

                const data = await response.json();
                const summaryText = data.content[0].text;

                // Parse and save
                const [summary, factsSection] = summaryText.split('FAKTEN:');
                
                // Save daily session
                const today = new Date().toISOString().split('T')[0];
                await supabaseClient.from('daily_sessions').upsert({
                    user_id: currentUser.id,
                    session_date: today,
                    summary: summary.trim(),
                    mood: extractMood(summary),
                    topics: extractTopics(summary)
                });

                // Save facts
                if (factsSection) {
                    const factLines = factsSection.trim().split('\n');
                    for (const line of factLines) {
                        const match = line.match(/^-?\s*(\w+)\|(\w+)\|(.+)$/);
                        if (match) {
                            await supabaseClient.from('user_facts').upsert({
                                user_id: currentUser.id,
                                category: match[1].trim(),
                                fact_key: match[2].trim(),
                                fact_value: match[3].trim()
                            });
                        }
                    }
                }

                await loadUserMemory();
            } catch (e) {
                console.error('Summary error:', e);
            }
        }

        function extractMood(text) {
            const match = text.match(/Stimmung[:\s]*(\d)/i);
            return match ? parseInt(match[1]) : 5;
        }

        function extractTopics(text) {
            const topics = [];
            const keywords = ['Arbeit', 'Familie', 'Beziehung', 'Angst', 'Stress', 'Freude', 'Trauer', 'Gesundheit'];
            keywords.forEach(k => { if (text.toLowerCase().includes(k.toLowerCase())) topics.push(k); });
            return topics;
        }

        // Chat History
        async function loadChatHistory() {
            const { data } = await supabaseClient
                .from('conversations')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(10);

            chatHistoryList.innerHTML = '';
            (data || []).forEach(conv => {
                const btn = document.createElement('button');
                btn.className = 'sidebar-item chat-history-item';
                btn.innerHTML = `
                    <span class="sidebar-icon">üí¨</span>
                    <span class="sidebar-text">${conv.title || 'Chat'}</span>
                `;
                btn.onclick = () => loadConversation(conv.id);
                chatHistoryList.appendChild(btn);
            });
        }

        async function loadConversation(convId) {
            currentConversationId = convId;
            
            const { data: messages } = await supabaseClient
                .from('messages')
                .select('*')
                .eq('conversation_id', convId)
                .order('created_at', { ascending: true });

            chatMessages.innerHTML = '';
            conversationHistory = [];
            
            (messages || []).forEach(msg => {
                addMessage(msg.content, msg.role === 'user');
                conversationHistory.push({ role: msg.role, content: msg.content });
            });

            sidebar.classList.remove('mobile-open');
        }

        // Profile
        async function loadProfile() {
            if (!userProfile) return;
            document.getElementById('profile-nenner').value = userProfile.nenner || '';
            document.getElementById('profile-alter').value = userProfile.alter_jahre || '';
            document.getElementById('profile-geschlecht').value = userProfile.geschlecht || '';
            document.getElementById('profile-ort').value = userProfile.ort || '';
            document.getElementById('profile-hobbies').value = userProfile.hobbies?.join(', ') || '';
        }

        async function saveProfile() {
            const data = {
                id: currentUser.id,
                email: currentUser.email,
                nenner: document.getElementById('profile-nenner').value,
                alter_jahre: parseInt(document.getElementById('profile-alter').value) || null,
                geschlecht: document.getElementById('profile-geschlecht').value,
                ort: document.getElementById('profile-ort').value,
                hobbies: document.getElementById('profile-hobbies').value.split(',').map(h => h.trim()).filter(h => h),
                updated_at: new Date().toISOString()
            };
            await supabaseClient.from('profiles').upsert(data);
            userProfile = data;
        }

        // Messages
        async function saveMessage(content, role) {
            if (!currentConversationId) return;
            await supabaseClient.from('messages').insert([{
                conversation_id: currentConversationId,
                role, content
            }]);
        }

        function addMessage(content, isUser) {
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'bot'}`;
            div.innerHTML = isUser 
                ? `<div class="message-content">${escapeHtml(content)}</div>`
                : `<div class="bot-avatar">C</div><div class="message-content">${escapeHtml(content)}</div>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Speak bot messages
            if (!isUser) {
                speak(content);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showTyping() {
            const div = document.createElement('div');
            div.className = 'message bot';
            div.id = 'typing';
            div.innerHTML = `<div class="bot-avatar">C</div><div class="typing-indicator"><span></span><span></span><span></span></div>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typing')?.remove();
        }

        function showError(msg) {
            errorMessage.textContent = msg;
            errorMessage.style.display = 'block';
            setTimeout(() => errorMessage.style.display = 'none', 5000);
        }

        function showSuccess(msg) {
            successMessage.textContent = msg;
            successMessage.style.display = 'block';
            setTimeout(() => successMessage.style.display = 'none', 3000);
        }

        // Claude API
        async function sendWelcomeMessage() {
            showTyping();
            
            // Check if returning user or new
            const isReturning = userProfile?.nenner || userFacts.length > 0 || recentSummaries.length > 0;
            
            // Check for sleep concerns
            const sleepConcern = getSleepConcernMessage();
            
            // Check for due reminders
            const dueReminders = getPendingRemindersText();
            
            let welcomePrompt;
            if (isReturning && userProfile?.nenner) {
                // Returning user with name
                welcomePrompt = `Begr√º√üe ${userProfile.nenner} kurz und herzlich zur√ºck. 
Maximal 2-3 S√§tze.`;
                
                if (sleepConcern) {
                    welcomePrompt += `\nEs ist ${new Date().toLocaleTimeString('de-DE')} Uhr. ${sleepConcern}`;
                } else if (dueReminders) {
                    welcomePrompt += `\nErw√§hne kurz: "${dueReminders}"`;
                } else {
                    welcomePrompt += `\nFrag wie es ihm/ihr heute geht.`;
                }
            } else if (isReturning) {
                // Returning but no name
                welcomePrompt = `Begr√º√üe den User kurz zur√ºck. Maximal 2 S√§tze.
Frag nach seinem Namen, du hattest ihn noch nicht.`;
            } else {
                // New user - short onboarding
                welcomePrompt = `Erste Begr√º√üung f√ºr neuen User.
WICHTIG: Maximal 2 kurze S√§tze!
Sag nur: "Hey! Ich bin CEXO. Wie darf ich dich nennen? üñ§"
Nichts weiter erkl√§ren, keine langen Texte.`;
            }

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 100,
                        system: buildSystemPrompt(),
                        messages: [{ role: 'user', content: welcomePrompt }]
                    })
                });

                const data = await response.json();
                const msg = data.content[0].text;
                hideTyping();
                addMessage(msg, false);
                await saveMessage(msg, 'assistant');
                conversationHistory.push({ role: 'assistant', content: msg });
            } catch (e) {
                hideTyping();
                // Fallback
                const fallback = userProfile?.nenner 
                    ? `Hey ${userProfile.nenner}! Sch√∂n dass du wieder da bist. Wie geht's dir heute? üñ§`
                    : `Hey! Ich bin CEXO. Wie darf ich dich nennen? üñ§`;
                addMessage(fallback, false);
                await saveMessage(fallback, 'assistant');
                conversationHistory.push({ role: 'assistant', content: fallback });
            }
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text || !isConnected) return;

            // Track activity
            await trackActivity('message');

            addMessage(text, true);
            await saveMessage(text, 'user');
            conversationHistory.push({ role: 'user', content: text });
            
            userInput.value = '';
            sendBtn.disabled = true;
            userInput.disabled = true;
            showTyping();

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        system: buildSystemPrompt(),
                        messages: conversationHistory
                    })
                });

                const data = await response.json();
                const msg = data.content[0].text;
                hideTyping();
                addMessage(msg, false);
                await saveMessage(msg, 'assistant');
                conversationHistory.push({ role: 'assistant', content: msg });
            } catch (e) {
                hideTyping();
                showError('Fehler: ' + e.message);
                conversationHistory.pop();
            } finally {
                sendBtn.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        async function connectAPI() {
            const key = apiKeyInput.value.trim();
            if (!key?.startsWith('sk-ant-')) return showError('Ung√ºltiger API-Key');

            apiKey = key;
            connectBtn.disabled = true;
            statusText.textContent = 'Verbinde...';
            statusIndicator.className = 'status-indicator connecting';

            try {
                // Test connection
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 50,
                        messages: [{ role: 'user', content: 'Hi' }]
                    })
                });

                if (!response.ok) throw new Error('API Error');

                isConnected = true;
                statusIndicator.className = 'status-indicator';
                statusText.textContent = 'Online üñ§';
                chatArea.classList.add('show');
                apiKeyInput.disabled = true;
                connectBtn.textContent = 'Verbunden ‚úì';

                // Load existing or send welcome
                if (conversationHistory.length === 0) {
                    await sendWelcomeMessage();
                }

                userInput.focus();
            } catch (e) {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'Fehler';
                showError('Verbindung fehlgeschlagen');
                apiKey = '';
            } finally {
                connectBtn.disabled = false;
            }
        }

        // Events
        connectBtn.addEventListener('click', connectAPI);
        apiKeyInput.addEventListener('keypress', e => { if (e.key === 'Enter') connectAPI(); });
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

        // TTS Settings listeners
        document.getElementById('settings-tts')?.addEventListener('change', (e) => {
            localStorage.setItem('cexo_tts', e.target.value);
            ttsEnabled = e.target.value === 'on';
            if (!ttsEnabled) stopSpeaking();
        });

        document.getElementById('settings-voice')?.addEventListener('change', (e) => {
            localStorage.setItem('cexo_voice', e.target.value);
        });

        // Init
        (async () => {
            // Init TTS
            initTTS();
            
            // Load saved API key
            const savedKey = localStorage.getItem('cexo_api_key');
            if (savedKey) {
                apiKeyInput.value = savedKey;
            }

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) handleAuthSuccess(session.user);
        })();
    </script>
</body>
</html>
